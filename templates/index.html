<!DOCTYPE html>
<html>
  <head>
    <title>Hudl</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="static/css/style.css">
  </head>
  <body>
    <div id="map"></div>
    <script>
      var map;

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 39.797, lng: -104.958},
          zoom: 12
        });

        var colors = ['red', 'green', 'blue', 'yellow'];
        var numColors = colors.length;
        var colorIndex = 0;

        map.addListener('click', function(event) {
          var lat = event.latLng.lat();
          var lng = event.latLng.lng();
          var url = '/api/highways/?lat='+lat+'&lon='+lng;

          var marker = new google.maps.Marker({
            position: {lat, lng},
            map: map,
            title: 'Location Info',
            icon : 'http://maps.google.com/mapfiles/ms/icons/' + colors[colorIndex] + '-dot.png'
          });

          var infowindow = new google.maps.InfoWindow({
            content: `
              <div class="spinner">
                <div class="bounce1"></div>
                <div class="bounce2"></div>
                <div class="bounce3"></div>
              </div>
            `
          });

          infowindow.open(map, marker);


          colorIndex = (colorIndex + 1) % numColors;

          fetch(url).then(function(response) {return response.json(); }).then(function(json) {
                if (json.length == 0) {
                  var windowContent = "<h4>No highways within 1000ft.</h4>"
                } else {

                  var windowContent = `
                    <div>
                      <h3>67.3 DNL</h3>
                  `
                  json.forEach(function(element) {
                    var elemContent = `
                      Street: `+ element.street_name+`<br>
                      DNL: `+element.total_dnl+`<br>
                      Trucks: 4%<br>
                      AADT: `+Number(element.future_aadt).toLocaleString()+`<br><br>
                    `;
                    windowContent = windowContent.concat(elemContent);
                  });
                }

                infowindow.setContent(windowContent);


                // infowindow.setContent(json.map(function(elem) {
                //     return elem.street_name + ": "+ elem.effective_future_aadt
                //   }).join("<br>"));
            });
        })
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB20D3rZ8LVMzQg9_3ABmZ_IlkoakQMRKo&callback=initMap"
    async defer></script>
  </body>
</html>
